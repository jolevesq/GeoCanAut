(function(){define(["jquery-private","knockout","gcaut-i18n","gcaut-func","gcaut-gisservinfo"],function(h,i,j,f,b){var c,e,d,g,a;c=function(m,n,l){var k=function(r,o,w){var u=this,t=w.length,s=f.getListCB(j.getDict("%legend-visibilitytypelist")),p=f.getListCB(j.getDict("%map-layertypelist")),v=locationPath+"gcaut/images/legendOpen.png",q=locationPath+"gcaut/images/legendOpen.png";u.imgOpen=v;u.imgAddGroup=q;u.msgOpacity=j.getDict("%legend-msgopacity");u.lblReset=j.getDict("%reset");u.lblRemove=j.getDict("%remove");u.lblEnable=j.getDict("%legend-enable");u.lblExpand=j.getDict("%expand");u.lblItemExpand=j.getDict("%legend-expand");u.lblLabel=j.getDict("%legend-label");u.lblMeta=j.getDict("%legend-metadata");u.lblMetaUrl=j.getDict("%legend-metaurl");u.lblMetaText=j.getDict("%legend-metatext");u.lblOpacity=j.getDict("%legend-opacity");u.lblOpacityInit=j.getDict("%legend-opacityinit");u.lblOpacityMin=j.getDict("%minimum");u.lblOpacityMax=j.getDict("%maximum");u.lblVisibility=j.getDict("%legend-visibility");u.lblVisibilityState=j.getDict("%legend-visibilitystate");u.lblVisibilityType=j.getDict("%legend-visibilitytype");u.lblVisibilityRadio=j.getDict("%legend-visibilityradioid");u.lblDisplayChild=j.getDict("%legend-displaychild");u.lblDisplayChildSymbol=j.getDict("%legend-displaychildsymbol");u.lblCustomImage=j.getDict("%legend-customimage");u.lblCustomImageUrl=j.getDict("%legend-customimageurl");u.lblCustomImageText=j.getDict("%legend-customimagetext");u.lblSectBases=j.getDict("%legend-sectbases");u.lblSectLayers=j.getDict("%legend-sectlayers");u.lblEmptyGrp=j.getDict("%legend-emptygrp");u.lblResetTitle=j.getDict("%legend-titlereset");u.lblResetText=j.getDict("%legend-txtreset");u.tpRefresh=j.getDict("%projheader-tpnewmap");u.hiddenReset=i.observable("gcaut-hidden");u.isEnable=i.observable(o.enable);u.isExpand=i.observable(o.expand);u.visibilityType=s;u.opacityValue=false;u.layerType=p;u.holderLayers=o.items;u.legendLayers=i.observableArray(o.items);u.holderBases=o.basemaps;u.legendBases=i.observableArray(o.basemaps);u.itemsBases=i.observableArray();u.itemsLayers=i.observableArray();u.isResetDialogOpen=i.observable();u.updateInitState=function(y,x){if(!y){x(true)}};u.updateCustom=function(y,x){if(y){x(false)}};u.updateOpacity=function(y,x){u.opacityValue=y;u.updateOpacityChild(x,y)};u.updateOpacityChild=function(x){i.utils.arrayForEach(x,function(y){if(u.opacityValue){y.opacity.enable(false);y.opacity.canenable(false)}else{y.opacity.canenable(true)}u.updateOpacityChild(y.items())})};d=function(E){var B=E.label,C=E.metadata,A=E.opacity,z=E.visibility,y=E.displaychild,x=E.customimage,D=A.enable;E.expand=i.observable(E.expand);E.last=i.observable(E.last);E.type=i.observable(E.type);E.id=i.observable(E.id);E.graphid=i.observable(E.graphid);E.displayfields=i.observable(E.displayfields),E.label.value=i.observable(B.value);E.label.alttext=i.observable(B.alttext);E.metadata.enable=i.observable(C.enable);E.metadata.value=i.observable(C.value);E.metadata.alttext=i.observable(C.alttext);E.opacity.enable=i.observable(A.enable);E.opacity.canenable=i.observable(u.opacityValue);E.opacity.min=i.observable(A.min).extend({numeric:{precision:2}});E.opacity.max=i.observable(A.max).extend({numeric:{precision:2}});E.opacity.initstate=i.observable(A.initstate).extend({numeric:{precision:2,validation:{min:E.opacity.min,max:E.opacity.max,id:"msg_opacityInit"+E.graphid(),msg:u.msgOpacity}}});E.visibility.enable=i.observable(z.enable);E.visibility.initstate=i.observable(z.initstate);E.visibility.type=i.observable(u.visibilityType[z.type-1]);E.visibility.radioid=i.observable(z.radioid).extend({numeric:{precision:0}});E.displaychild.enable=i.observable(y.enable);E.displaychild.symbol=i.observable(y.symbol);E.customimage.enable=i.observable(x.enable);E.customimage.url=i.observable(x.url);E.customimage.alttext=i.observable(x.alttext);E.items=i.observableArray(E.items);E.visibility.enable.subscribe(function(){u.updateInitState(E.visibility.enable(),E.visibility.initstate)});E.displaychild.enable.subscribe(function(){u.updateCustom(E.displaychild.enable(),E.customimage.enable)});E.opacity.enable.subscribe(function(){u.updateOpacity(E.opacity.enable(),E.items())});if(D){u.opacityValue=false}return E};u.createArray=function(x){i.utils.arrayForEach(x.items(),function(y){y=d(y);u.createArray(y)})};i.utils.arrayForEach(u.legendLayers(),function(x){u.opacityValue=true;x=d(x);u.createArray(x)});i.utils.arrayForEach(u.legendBases(),function(x){u.opacityValue=true;x=d(x);u.createArray(x)});e(i,r);u.init=function(){return{controlsDescendantBindings:true}};u.bind=function(){setTimeout(function(){var y=h(".legendSortBases"),x=h(".legendSortLayers");y.accordion("refresh");y.on("sortupdate",f.debounce(function(){u.sortArray(y)},250,false));x.accordion("refresh");x.on("sortupdate",f.debounce(function(){u.sortArray(h(".legendSortLayers-lvl1"))},250,false))},500);e(i,h("#legend_reset")[0]);e(i,r);i.applyBindings(u,r)};u.getLayerType=function(x){return f.getListValue(u.layerType,x.type())};u.resetArray=function(D,I){var B,y,H,x,J,L,G,E,K=(typeof D==="undefined")?[]:D,F=[],C=K.length-1,A=0,z=0;if(I==="bases"){u.legendBases([]);u.itemsBases([]);E=u.itemsBases}else{if(I==="layers"){u.legendLayers([]);u.itemsLayers([]);E=u.itemsLayers}}while(A<=C){J=K[A];y=J.id;x=J.url;G=J.type;F=J.label.split("***");H=F.length-1;z=0;if(G===5||G===2){L=(H===0)?true:false;B=u.unique(E,F[0],y,L,x,G);z++;while(z<=H){L=(z===H)?true:false;B=u.unique(B.items,F[z],y,L,x,G);z++}}else{if(G===4){b.getEsriServRendererInfo(E,x,y,u.esriDymanicServ)}}A++}};u.updateLayers=function(x){u.holderLayers=x};u.updateBases=function(x){u.holderBases=x};u.esriDymanicServ=function(G,x,A,C){var E,z,D,y,B=0,F=C.length-1;D=x.lastIndexOf("/");x=x.substring(0,D);z=x.lastIndexOf("/")+1;y=x.substring(z,D);G.push(g(y,y,false,"",4));G=G()[G().length-1].items;while(B!==F){E=C[B];B++;if(E.type==="Feature Layer"&&E.parentLayer===null){G.push(g(E.name,A,true,"",4,E.drawingInfo.renderer))}else{if(E.type==="Group Layer"&&E.parentLayer===null){G.push(g(E.name,A,false,"",4));u.esriDynamicSublayer(G()[G().length-1].items,E.subLayers,A,C)}}}u.esriDynamicVis(G())};u.esriDynamicVis=function(y){var z,x=y.length;while(x--){z=y[x];z.visibility.enable(false);u.esriDynamicVis(z.items())}};u.esriDynamicSublayer=function(E,B,y,A){var C,F,x,z=B.reverse(),D=z.length;while(D--){C=z[D];F=A[C.id];x=F.name;if(F.type==="Feature Layer"){E.push(g(x,y,true,"",4,F.drawingInfo.renderer))}else{if(F.type==="Group Layer"){E.push(g(x,y,false,"",4));u.esriDynamicSublayer(E()[E().length-1].items,F.subLayers,y,A)}}}};u.unique=function(y,D,E,C,z,A){var B,x=y().length;while(x--){B=y()[x];if(B.label.value()===D){return B}}y.push(g(D,E,C,z,A));return y()[y().length-1]};g=function(C,D,A,x,y,B){var z;z={expand:i.observable(false),last:i.observable(A),type:i.observable(y),id:i.observable(D),graphid:i.observable(f.getUUID()),displayfields:i.observable(false),label:{value:i.observable(C),alttext:i.observable(C)},metadata:{enable:i.observable(false),value:i.observable(),alttext:i.observable()},opacity:{enable:i.observable(false),canenable:i.observable(true),min:i.observable(0).extend({numeric:{precision:2}}),max:i.observable(100).extend({numeric:{precision:2}})},visibility:{enable:i.observable(true),initstate:i.observable(true),type:i.observable(u.visibilityType[0]),radioid:i.observable().extend({numeric:{precision:0}})},displaychild:{enable:i.observable(true),symbol:i.observable()},customimage:{enable:i.observable(false),url:i.observable(),alttext:i.observable()},items:i.observableArray()};z.opacity.initstate=i.observable(1).extend({numeric:{precision:2,validation:{min:z.opacity.min,max:z.opacity.max,id:"msg_opacityInit"+z.graphid(),msg:u.msgOpacity}}});if(A&&typeof B==="undefined"){b.getEsriRendererInfo(x,z)}else{if(A&&typeof B!=="undefined"){z.displaychild.symbol(JSON.stringify(B))}}z.visibility.enable.subscribe(function(){u.updateInitState(z.visibility.enable(),z.visibility.initstate)});z.displaychild.enable.subscribe(function(){u.updateCustom(z.displaychild.enable(),z.customimage.enable)});z.opacity.enable.subscribe(function(){u.updateOpacity(z.opacity.enable(),z.items())});return z};u.removeBase=function(x,y){u.removeItem(x,u.legendBases,y);h(".legendSortBases").accordion("refresh")};u.removeLayer=function(x,y){u.removeItem(x,u.legendLayers,y);h(".legendSortLayers").accordion("refresh")};u.removeItem=function(y,A,z){var x=y.length-1;if(x===0){A.remove(z)}else{y[0].items.remove(z)}};u.sortArray=function(A){var x,C,z,y,B,D=[];x=u.getArrayHTML(h(A));C=u.legendLayers().length;while(C--){D=u.addFlatChildren(u.legendLayers,D)}z=D.length;while(z--){D[z].items([])}y=u.updateArrayRec(x,D,i.observableArray([]));u.legendLayers(y());B=u.legendLayers().slice(0);u.legendLayers([]);u.legendLayers(B);h(".legendSortLayers").accordion("refresh")};u.addFlatChildren=function(B,x){var A;B=i.utils.unwrapObservable(B);if(B){for(var z=0,y=B.length;z<y;z++){A=B[z];x.push(A);u.addFlatChildren(A.items,x)}}return x};u.getObject=function(y,A){var z,x=y.length;while(x--){z=y[x];if(A===z.graphid()){return z}}};u.getArrayHTML=function(A){var C,B,y=[],z=h(A).children(),x=z.length;while(x--){C=h(z[x]);B={graphid:h(C.find("h3").find("span")[1]).attr("id")};B.graphids=u.getArrayHTML(C.children("div").children(".inner-layer-list").children("ul"));y.push(B)}return y};u.updateArrayRec=function(y,C,z){var B,A=0,x=y.length;while(x--){B=y[x];if(B.graphids.length===0){z.push(u.getObject(C,B.graphid))}else{z().push(u.getObject(C,B.graphid));u.updateArrayRec(B.graphids,C,z()[A].items)}A++}return z};u.openCloseAll=function(D,A){var E=h(A.target.parentElement.parentElement).attr("id"),z=h(A.target.parentElement.parentElement.parentElement),y=z.find("#"+E),C=z.find("#"+E.replace("header","panel")),x=C.find("li > h3"),B=C.find("li > div");if(y.hasClass("ui-accordion-header-active")){y.removeClass("ui-accordion-header-active ui-state-active ui-corner-top").addClass("ui-corner-all").attr({"aria-selected":"false",tabindex:"-1"});y.find(".ui-icon").removeClass("ui-icon-triangle-1-s").addClass("ui-icon-triangle-1-e");C.removeClass("ui-accordion-content-active").attr({"aria-expanded":"false","aria-hidden":"true"}).hide();x.removeClass("ui-accordion-header-active ui-state-active ui-corner-top").addClass("ui-corner-all").attr({"aria-selected":"false",tabindex:"-1"});x.find(".ui-icon").removeClass("ui-icon-triangle-1-s").addClass("ui-icon-triangle-1-e");B.removeClass("ui-accordion-content-active").attr({"aria-expanded":"false","aria-hidden":"true"}).hide()}else{y.removeClass("ui-corner-all").addClass("ui-accordion-header-active ui-state-active ui-corner-top").attr({"aria-selected":"true",tabindex:"0"});y.find(".ui-icon").removeClass("ui-icon-triangle-1-e").addClass("ui-icon-triangle-1-s");C.addClass("ui-accordion-content-active").attr({"aria-expanded":"true","aria-hidden":"false"}).show();x.removeClass("ui-corner-all").addClass("ui-accordion-header-active ui-state-active ui-corner-top").attr({"aria-selected":"true",tabindex:"0"});x.find(".ui-icon").removeClass("ui-icon-triangle-1-e").addClass("ui-icon-triangle-1-s");B.addClass("ui-accordion-content-active").attr({"aria-expanded":"true","aria-hidden":"false"}).show()}A.preventDefault()};u.createEmptyGrp=function(){var x=g(u.lblEmptyGrp,f.getUUID(),false,"",0);u.legendLayers.push(x);h(".legendSortLayers").accordion("refresh")};u.reset=function(){u.isResetDialogOpen(true);u.hiddenReset("")};u.dialogResetOk=function(){u.resetArray(u.holderBases,"bases");u.resetArray(u.holderLayers,"layers");setTimeout(function(){u.legendBases(u.itemsBases());u.legendLayers(u.itemsLayers());h(".legendSortBases").accordion("refresh");h(".legendSortLayers").accordion("refresh");u.dialogResetCancel()},1000)};u.dialogResetCancel=function(){u.hiddenReset("gcaut-hidden");u.isResetDialogOpen(false)};u.write=function(){var y,z,x;z=JSON.stringify(i.toJS(u.legendBases)).replace(/{"id":/g,"").replace(/,"val":"radio"}/g,"").replace(/,"val":"case"}/g,"");x=JSON.stringify(i.toJS(u.legendLayers)).replace(/{"id":/g,"").replace(/,"val":"radio"}/g,"").replace(/,"val":"case"}/g,"");z=z.replace(/,"canenable":false/g,"").replace(/,"canenable":true/g,"");x=x.replace(/,"canenable":false/g,"").replace(/,"canenable":true/g,"");y='"toolbarlegend": {"enable": '+u.isEnable()+',"expand": '+u.isExpand()+',"basemaps": '+z+',"items": '+x+"}";return y};while(t--){w[t].value.subscribe(u[w[t].func],u)}u.init()};a=new k(m,n,l);i.applyBindings(a,m);return a};e=function(k,l){k.cleanNode(l)};return{initialize:c,clean:e}})}).call(this);