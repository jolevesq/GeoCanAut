/*!
 *
 * GeoCanAut tools / Outil GÃ©oCanAut
 * geocanaut.github.io/geocanaut/License-eng.txt / geocanaut.github.io/geocanaut/Licence-fra.txt
 *
 *  Project header view model widget
 */
(function(){define(["jquery-private","knockout","genfile","gcaut-i18n","gcaut-ko","gcaut-func","gcaut-vm-map","gcaut-vm-header","gcaut-vm-footer","gcaut-vm-legend","gcaut-vm-draw","gcaut-vm-nav","gcaut-vm-data"],function(o,p,c,q,k,m,e,f,b,n,a,j,l){var h,g,i,d;h=function(t,s){var r=function(w){var u=this,v=locationPath+"gcaut/images/projNew.png",x=locationPath+"gcaut/images/projOpen.png",A=locationPath+"gcaut/images/projDelete.gif",y=locationPath+"gcaut/images/projRestore.gif",z=locationPath+"gcaut/images/projSave.png",B=locationPath+"gcaut/config/gcviz-default.json";u.imgNew=v;u.imgOpen=x;u.imgDelete=A;u.imgRestore=y;u.imgSave=z;u.headerLabel=q.getDict("%projheader-title");u.newLabel=q.getDict("%projheader-newlabel");u.saveLabel=q.getDict("%projheader-savelabel");u.mapLabel=q.getDict("%map")+" ";u.mapsLabel=p.observable(" "+q.getDict("%of")+" "+q.getDict("%map")+"(s)");u.txtOf=q.getDict("%of");u.txtMaps=q.getDict("%map")+"(s)";u.txtConfig=q.getDict("%msg-configread")+": ";u.txtConfigErr=q.getDict("%msg-configerr");u.tpNew=q.getDict("%projheader-tpnewmap");u.tpSave=q.getDict("%projheader-tpsavemap");u.tpOpen=q.getDict("%projheader-tpopenmap");u.tpDelete=q.getDict("%projheader-tpdeletemap");u.tpRestore=q.getDict("%projheader-tprestoremap");u.maps=[];u.mapsRestore=[];u.mapsID=p.observableArray([]);u.mapsIDValue=p.observable();u.init=function(){return{controlsDescendantBindings:true}};u.launchDialog=function(){o(document.getElementById("fileDialogOpen"))[0].click()};u.openMap=function(F,H){var E,D,G=H.target.files,C=G.length;while(C--){E=G[C];D=new FileReader();D.onload=g();D.readAsText(E)}document.getElementById("fileDialogOpen").value=""};g=function(){return function(E){var D;try{D=JSON.parse(E.target.result);u.initMap(D)}catch(C){console.log(u.txtConfigErr+": "+C)}}};u.newMap=function(){u.readConfig(B)};u.deleteMap=function(){var E=parseInt(u.mapsIDValue().split(" ")[1],10)-1,C=u.maps.splice(E,1),D=d.maps;u.mapsRestore.push(C[0]);u.resetIndex();i(D[D.length-1].map.focusMapHeight)};u.restoreMap=function(){var C=u.mapsRestore.length,D=d.maps;while(C--){u.maps.push(u.mapsRestore.shift())}u.resetIndex();i(D[D.length-1].map.focusMapHeight)};u.saveMap=function(){var E=u.mapsIDValue(),C=u.maps[parseInt(E.split(" ")[1],10)-1],D='{"gcviz": {';Object.keys(C).forEach(function(F){D+=C[F].write();D+=","});D+='"insetframe": {"enable": false},';D+='"customwidgets": []';D+="}}";o.generateFile({filename:E+".json",content:D,script:w.phpdownload});setTimeout(function(){o("#gcaut-download").remove()},3000,false)};u.resetIndex=function(){var E,C=u.maps.length,D=u.maps.length;u.mapsID([]);while(C--){E=D-C;u.mapsID.push(u.mapLabel+E)}u.mapsIDValue(u.mapLabel+D);u.mapsLabel(" "+u.txtOf+" "+u.mapsID().length+" "+u.txtMaps)};u.readConfig=function(C){o.support.cors=true;o.ajax({url:C,crossDomain:true,dataType:"json",async:false,success:function(D){u.initMap(D)},error:function(){console.log(u.txtConfigErr+": "+C)}})};u.initMap=function(E){var F={},G=u.maps.length+1,C=u.mapLabel+G,D=E.gcviz;F.map=e.initialize(document.getElementById("map"),D.mapframe);F.header=f.initialize(document.getElementById("headerMap"),D.header,[{value:F.map.mapWidthValue,func:"updateTitle"}]);F.footer=b.initialize(document.getElementById("footerMap"),D.footer,[{value:F.map.selectMapSR,func:"updateSR"}]);F.legend=n.initialize(document.getElementById("legendMap"),D.toolbarlegend,[{value:F.map.layers,func:"updateLayers"},{value:F.map.bases,func:"updateBases"}]);F.draw=a.initialize(document.getElementById("drawMap"),D.toolbardraw);F.navigation=j.initialize(document.getElementById("navigationMap"),D.toolbarnav);F.data=l.initialize(document.getElementById("dataMap"),D.toolbardata);i(F.map.focusMapHeight);u.maps.push(F);u.mapsID.push(C);u.mapsIDValue(C);u.mapsLabel(" "+u.txtOf+" "+u.mapsID().length+" "+u.txtMaps);console.log(u.txtConfig);m.setVM(F)};i=function(C){o("#gcauttabs").tabs("option","active",0);o("#gcautmaptabs").tabs("option","active",0);setTimeout(function(){o("#gcaut-lods").accordion("option","active",false)},0);setTimeout(function(){C(true)},0)};u.mapsIDValue.subscribe(function(E){if(typeof E!=="undefined"){var F=parseInt(E.split(" ")[1],10)-1,D=u.maps[F],C=o("#gcauttabs");if(typeof D!=="undefined"){Object.keys(D).forEach(function(G){D[G].bind()})}m.setVM(D);i(D.map.focusMapHeight);if(u.mapsID().length===0){C.tabs("option",{collapsible:true,active:false,disabled:true})}else{if(u.mapsID().length===1){C.tabs("option",{collapsible:false,disabled:false,active:0})}}}});u.init()};d=new r(s);p.applyBindings(d,t)};return{initialize:h}})}).call(this);